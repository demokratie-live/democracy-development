kind: Build
name: import-procedures
description: Import procedures for the bundestag.io API
type: container
source:
  path: ../../../
include:
  - ./**/*
  - ./infra/Dockerfile
spec:
  dockerfile: ./infra/Dockerfile
  buildArgs:
    NODE_VERSION: 20.9.0
    SERVICE: crawler
    SERVICE_PATH: services/cron-jobs/crawler
  extraFlags: ['--load']

---
kind: Run
name: import-procedures
description: Ad-hoc import-Job for Prozeduren
dependencies:
  - build.import-procedures
  - deploy.mongo

varfiles:
  - path: .env
    optional: true
  - path: .env.local
    optional: true

variables:
  DB_URL: mongodb://democracy-mongo:27017/bundestagio

type: kubernetes-pod
spec:
  podSpec:
    restartPolicy: Never
    containers:
      - name: import-procedures
        image: ${actions.build.import-procedures.outputs.deploymentImageId}
        imagePullPolicy: IfNotPresent
        env:
          - name: DB_URL
            value: ${var.DB_URL}
          - name: DIP_API_KEY
            valueFrom:
              secretKeyRef:
                name: dip-api-token
                key: DIP_API_KEY
          - name: DEBUG
            value: '${var.DEBUG || "false"}'
          - name: IMPORT_PROCEDURES_CHUNK_ROUNDS
            value: '${var.IMPORT_PROCEDURES_CHUNK_ROUNDS || "5"}'
          - name: IMPORT_PROCEDURES_CHUNK_SIZE
            value: '${var.IMPORT_PROCEDURES_CHUNK_SIZE || "100"}'
          - name: IMPORT_PROCEDURES_FILTER_AFTER
            value: '${var.IMPORT_PROCEDURES_FILTER_AFTER || ""}'
          - name: IMPORT_PROCEDURES_FILTER_TYPES
            value: '${var.IMPORT_PROCEDURES_FILTER_TYPES || ""}'
          - name: IMPORT_PROCEDURES_START_CURSOR
            value: '${var.IMPORT_PROCEDURES_START_CURSOR || "*"}'
