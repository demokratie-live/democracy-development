kind: Build
name: sync-procedures
description: Import procedures for the bundestag.io API
type: container
source:
  path: ../../../
include:
  - ./**/*
  - ./infra/Dockerfile
spec:
  dockerfile: ./infra/Dockerfile
  buildArgs:
    NODE_VERSION: 20.9.0
    SERVICE: sync-procedures
    SERVICE_PATH: services/cron-jobs/sync-procedures
  extraFlags: ['--load']

---
kind: Run
name: sync-procedures
description: Ad-hoc import-Job for Procedures
dependencies:
  - build.sync-procedures
  - deploy.mongo
  - deploy.bundestag-io-api

variables:
  DB_URL: mongodb://democracy-mongo:27017/democracy
  BUNDESTAGIO_SERVER_URL: http://bundestag-io-api

type: kubernetes-pod
spec:
  podSpec:
    restartPolicy: Never
    containers:
      - name: sync-procedures
        image: ${actions.build.sync-procedures.outputs.deploymentImageId}
        imagePullPolicy: IfNotPresent
        env:
          - name: DB_URL
            value: ${var.DB_URL}
          - name: BUNDESTAGIO_SERVER_URL
            value: ${var.BUNDESTAGIO_SERVER_URL}
          - name: DEBUG
            value: '${var.DEBUG || "false"}'
